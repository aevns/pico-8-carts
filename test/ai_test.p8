pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- supercover --
function ray_test(a, b, draw)
    local err = nil
    if b.x == a.x then
        err = function(x, y)
            return abs(a.x - x)
        end
    else
        err = function(x, y)
            return abs(a.y + (x - a.x) * (b.y - a.y) / (b.x - a.x) - y)
        end
    end

    local x = flr(a.x) + 0.5
    local y = flr(a.y) + 0.5
    local sx = b.x > a.x and 1 or -1
    local sy = b.y > a.y and 1 or -1

    while abs(b.x - x) > 0.5 or abs(b.y - y) > 0.5 do
        if fget(mget(x, y), 1) then
            --mset(x, y, 2)
            if (draw) spr(2, x * 8 - 4, y * 8 - 4)
            return false
        else
            if (draw) spr(3, x * 8 - 4, y * 8 - 4)
        end
        if (err(x, y + sy) < err(x + sx, y)) then
            y += sy
        else
            x += sx
        end
    end
    if fget(mget(x, y), 1) then
        --mset(x, y, 2)
        if (draw) spr(2, x * 8 - 4, y * 8 - 4)
        return false
    else
        if (draw) spr(3, x * 8 - 4, y * 8 - 4)
    end
    return true
end
-->8
poke(0x5f2d, 1)

-- agent --

agent = {
				x = 4,
				y = 4,
				target = {x=4, y=4}
}

-- updates --

function _update60()
    if ray_test(
        				agent,
        				{
        								x = stat(32)/8,
        								y = stat(33)/8
        				}
    				)
    then
    				agent.target = {
    				    x = stat(32)/8,
    				    y = stat(33)/8
    				}
    end
    if abs(agent.target.x - agent.x) > 1/4 then
								agent.x += 1/16 * (agent.target.x - agent.x > 0 and 1 or -1)
				end
				if abs(agent.target.y - agent.y) > 1/4 then
								agent.y += 1/16 * (agent.target.y - agent.y > 0 and 1 or -1)
				end
end

function _draw()
				cls()
				map(0,0,0,0,127,127)
				test = ray_test(
								agent,
								{
												x = stat(32)/8,
												y = stat(33)/8
								},
								true
				)
				spr(6, agent.target.x * 8 - 4, agent.target.y * 8 - 4)
				spr(5, agent.x * 8 - 4, agent.y * 8 - 4)
				spr(0, stat(32), stat(33))
				print(test,0,123,test and 11 or 8)
end
__gfx__
aa00000077777777000000000000000011515151000000000099a700000000000000000000000000000000000000000000000000000000000000000000000000
49aaa00066666667088008800cc00cc001111115003bab0000099000000000000000000000000000000000000000000000000000000000000000000000000000
09999aaad6666667080000800c0000c01111111103ba7ab0a0000007000000000000000000000000000000000000000000000000000000000000000000000000
09999940d66666670000000000000000011111150baaa7a09700009a000000000000000000000000000000000000000000000000000000000000000000000000
04999900d66666670000000000000000111111110baaaab09a000099000000000000000000000000000000000000000000000000000000000000000000000000
009949a0d6666667080000800c0000c00111111503baab3090000009000000000000000000000000000000000000000000000000000000000000000000000000
0094049ad6666666088008800cc00cc011111111003bb300000a7000000000000000000000000000000000000000000000000000000000000000000000000000
00400040dddddddd0000000000000000010101010000000000999a00000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0002020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0104040404040404040104010401040100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0104040101040104040404040404040100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0104040101040104040401040104040100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0104040404040404040101010101040100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0104040404040404040104040401040100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0104040104010104040104010401040100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0104040104010104040104010401040100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0104040404040404040104010401040100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0104040404040404040404010404040100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0104040101040104040101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0104040101040104040404040404040100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0104040404040404040104010401040100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0104040404040404040404040404040100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
