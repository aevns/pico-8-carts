pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
agent = {
    sprite = 2,
    size = 1,
    x = 2,
    y = 2,
    ax = 0,
    ay = 0,
    speed = 1/2,
    unpathable = shl(1,2) + shl(1,3)
}

function agent:move_collide()
    oldx = self.x
    oldy = self.y
    self.x += self.speed * self.ax
    self.y += self.speed * self.ay

    -- not using 'horizontal first' yet; this will be sketchy

    for i = flr(self.x - self.size/2), flr(self.x + self.size/2)  do
        for j = flr(self.y - self.size/2), flr(self.y + self.size/2)  do
            colx, coly = self:collision_test(i, j)
            if colx or coly then
                self.x = colx
                self.y = coly
            end
        end
    end
end

function agent:collision_test(x, y)
    if (
        band(fget(mget(x, y)), self.unpathable) == 0 or
        abs(self.x - x - 0.5) > (1 + self.size)/2 or
        abs(self.y - y - 0.5) > (1 + self.size)/2
    ) then
        self.sprite = 1
        return nil, nil
    end
    self.sprite = 2
    -- return ideal push direction
    -- this is done by making many tests
    -- there's probably a more efficient way
    goodness = 0
    goodx = self.x
    goody = self.y
    for i= -1, 1 do
        for j= -1, 1 do
            if (
                i*j == 0 and
                self.ax * i <= 0 and
                self.ay * j <= 0 and
                (self.x - x - 0.5)*i + (self.y - y - 0.5)*j >= goodness and
                band(fget(mget(x + i, y + j)), self.pathable) == 0
            ) then
                goodness = (self.x - x - 0.5)*i + (self.y - y - 0.5)*j
                goodx = (i ~= 0) and x + 0.5 + i*(0.5 + self.size/2) or self.x
                goody = (j ~= 0) and y + 0.5 + j*(0.5 + self.size/2) or self.y
            end
        end
    end
    return goodx, goody
end
-->8
wait_time = 0

function _update60()
    if wait_time < time() then
        wait_time = time() + rnd(1)
        agent.ax = rnd(2)-1
        agent.ay = rnd(2)-1
    end
    agent:move_collide()
end

function _draw()
    cls()
    map(0, 0, 0, 0, 32, 32)
    spr(4, (agent.x+agent.ax)*8-4, (agent.y+agent.ay)*8-4)
    spr(agent.sprite, agent.x*8-4, agent.y*8-4)
end
__gfx__
000000000d0110d0000aa0009aaaaaaa00b000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000dd0000dd000000004994944ab000b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000cc000008008004999494a0000000b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700010c00c01a009900a4a99949a0b0bb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700010c00c01a009900a49a9994a000bb0b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000cc000008008004a9a999ab00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000dd0000dd000000004aa9a99a000b000b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000d0110d0000aa000444444490b000b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000030000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000003000000000000000303000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000030000000003000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000003030000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000303030000030303000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000303000003000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000003000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000030303000000000303000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000300000000000000000003000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000300000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300030303030300000303030300000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000303030300000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0300000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
